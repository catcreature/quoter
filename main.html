<script>
    const API_URL = 'https://api.quotable.io/random';

    let UNHANDLED_REJECTIONS = 0;
    window.addEventListener('unhandledrejection', (e) => {
        UNHANDLED_REJECTIONS += 1;
        e.preventDefault?.();
    });

    async function fetchWithTimeout(url, options = {}, timeoutMs = 2500, acceptHeader = 'application/json') {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const res = await fetch(url, {
                ...options,
                headers: { 'Accept': acceptHeader, ...(options.headers || {}) },
                signal: controller.signal,
            });
            return res;
        } finally {
            clearTimeout(id);
        }
    }

    const UNKNOWN_AUTHOR = 'Unknown';

    async function getQuote() {
        const res = await fetchWithTimeout(API_URL, {}, 2500, 'application/json');
        if (!res || !res.ok) throw new Error('bad status: ' + (res && res.status));
        const data = await res.json();
        if (!data || !data.content) throw new Error('bad payload');
        return { content: data.content, author: data.author || UNKNOWN_AUTHOR, source: 'api' };
    }

    function renderQuote(q) {
        const quoteEl = document.getElementById('quote');
        const authorEl = document.getElementById('author');
        const card = document.getElementById('quote-card');
        quoteEl.textContent = `“${q.content}”`;
        authorEl.textContent = `— ${q.author}`;
        card.setAttribute('aria-busy', 'false');
    }

    function runTests() {
        const results = [];
        function pass(name) { results.push({ name, ok: true }); }
        function fail(name, msg) { results.push({ name, ok: false, msg }); }

        const text = document.getElementById('quote')?.textContent?.trim() || '';
        if (text && text !== 'Loading quote…' && text.length > 5) pass('renders a quote to the page');
        else fail('renders a quote to the page', 'quote text missing or too short');

        // Remove local fallback variability test

        const author = document.getElementById('author')?.textContent?.trim() || '';
        if (author.startsWith('— ') && author.length > 3) pass('shows an author line');
        else fail('shows an author line', 'author line missing');

        if (UNHANDLED_REJECTIONS === 0) pass('no unhandled promise rejections');
        else fail('no unhandled promise rejections', `saw ${UNHANDLED_REJECTIONS}`);

        const busy = document.getElementById('quote-card')?.getAttribute('aria-busy');
        if (busy === 'false') pass('sets aria-busy to false after render');
        else fail('sets aria-busy to false after render', `aria-busy is ${busy}`);

        const out = document.getElementById('test-results');
        out.innerHTML = results.map(r => r.ok
            ? `<div class="test-pass">✔ ${r.name}</div>`
            : `<div class="test-fail">✘ ${r.name} — ${r.msg}</div>`
        ).join('');
    }

    (async () => {
        try {
            const q = await getQuote();
            renderQuote(q);
        } catch (err) {
            document.getElementById('quote').textContent = 'Failed to load quote.';
            document.getElementById('author').textContent = '';
        }
        runTests();
    })();
</script>
