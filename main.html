<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hello World with Quotes (CORS-safe)</title>
  <style>
    :root {
      --bg: #f0f8ff;
      --ink: #1f2937;
      --card: #ffffff;
      --muted: #6b7280;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(180deg, var(--bg), #e6f2ff);
      color: var(--ink);
      display: flex;
      flex-direction: column;
    }
    header {
      position: sticky;
      top: 0;
      background: #ecf0f1;
      backdrop-filter: saturate(130%) blur(4px);
      padding: 16px 24px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 1.75rem;
      display: inline-block;
      padding: 8px 16px;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    nav {
      display: flex;
      justify-content: center;
      background: #e6f2ff;
      border-bottom: 1px solid #d1e3f7;
    }
    .tab-btn {
      background: none;
      border: none;
      padding: 16px 32px;
      font-size: 1rem;
      cursor: pointer;
      color: var(--ink);
      transition: background .2s;
    }
    .tab-btn.active {
      background: #fff;
      border-bottom: 2px solid #1f2937;
      font-weight: bold;
    }
    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .quote-card, .world-card {
      max-width: 720px;
      width: 100%;
      background: var(--card);
      border-radius: 16px;
      padding: 28px 32px;
      box-shadow: 0 6px 24px rgba(0,0,0,.08);
      text-align: center;
      transition: transform .2s ease;
    }
    .quote-card:hover, .world-card:hover { transform: translateY(-2px); }
    .quote-text {
      font-size: clamp(1.2rem, 2.4vw, 1.75rem);
      line-height: 1.5;
    }
    .quote-author {
      margin-top: 12px;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .hint { margin-top: 10px; font-size: .85rem; color: var(--muted); }
    #test-results { margin: 18px auto 0; max-width: 720px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: #0f172a; }
    .test-pass { color: #065f46; }
    .test-fail { color: #991b1b; }
    .world-img {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,.10);
      margin-bottom: 12px;
    }
    .world-caption {
      color: var(--muted);
      font-size: 1rem;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Hello, Human! üåç</h1>
  </header>

  <nav>
    <button class="tab-btn active" id="tab-quotes" onclick="showTab('quotes')">Quotes</button>
    <button class="tab-btn" id="tab-world" onclick="showTab('world')">World Pic</button>
  </nav>

  <main>
    <article aria-live="polite" aria-busy="true" class="quote-card" id="quote-card">
      <div class="quote-text" id="quote">Loading quote‚Ä¶</div>
      <div class="quote-author" id="author"></div>
      <div class="hint" id="hint">Refresh for a new quote. If the network is blocked, a local random quote is shown.</div>
    </article>
    <article class="world-card" id="world-card" style="display:none;">
      <img class="world-img" src="https://upload.wikimedia.org/wikipedia/commons/9/97/The_Earth_seen_from_Apollo_17.jpg" alt="Earth from space" />
      <div class="world-caption">Earth as seen from Apollo 17 (NASA, 1972)</div>
    </article>
  </main>

  <section id="test-results" aria-label="Automated Tests"></section>

  <script>
    // Tab switching logic
    function showTab(tab) {
      document.getElementById('tab-quotes').classList.toggle('active', tab === 'quotes');
      // prevent noisy console logs in certain sandboxes
      e.preventDefault?.();
    });

    function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    async function fetchWithTimeout(url, options = {}, timeoutMs = 2500) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch(url, {
          ...options,
          headers: { 'Accept': 'application/json', ...(options.headers || {}) },
          signal: controller.signal,
        });
        return res;
      } finally {
        clearTimeout(id);
      }
    }

    async function getQuote() {
      try {
        const res = await fetchWithTimeout(API_URL, {}, 2500);
        if (!res || !res.ok) throw new Error('bad status: ' + (res && res.status));
        const data = await res.json();
        if (!data || !data.content) throw new Error('bad payload');
        return { content: data.content, author: data.author || 'Unknown', source: 'api' };
      } catch (err) {
        // Fallback when CORS/network fails
        const local = pickRandom(LOCAL_QUOTES);
        return { ...local, source: 'local', error: (err && err.message) || String(err) };
      }
    }

    function renderQuote(q) {
      const quoteEl = document.getElementById('quote');
      const authorEl = document.getElementById('author');
      const card = document.getElementById('quote-card');
      quoteEl.textContent = `‚Äú${q.content}‚Äù`;
      authorEl.textContent = `‚Äî ${q.author}`;
      card.setAttribute('aria-busy', 'false');
      const hint = document.getElementById('hint');
      hint.textContent = q.source === 'api'
        ? 'Loaded from API. Refresh for a new quote.'
        : 'Loaded from local list (network blocked). Refresh for a new quote.';
    }

    // --- Tests (existing tests kept, more added below) ---
    function runTests() {
      const results = [];
      function pass(name) { results.push({ name, ok: true }); }
      function fail(name, msg) { results.push({ name, ok: false, msg }); }

      // Test 1: quote text rendered (EXISTING)
      const text = document.getElementById('quote')?.textContent?.trim() || '';
      if (text && text !== 'Loading quote‚Ä¶' && text.length > 5) pass('renders a quote to the page');
      else fail('renders a quote to the page', 'quote text missing or too short');

      // Test 2: local randomizer produces variety (EXISTING)
      const sample = new Set();
      for (let i = 0; i < 12; i++) sample.add(pickRandom(LOCAL_QUOTES).content);
      if (sample.size > 1) pass('local fallback provides variability across runs');
      else fail('local fallback provides variability across runs', 'random picker not varying');

      // Test 3: author line present (EXISTING)
      const author = document.getElementById('author')?.textContent?.trim() || '';
      if (author.startsWith('‚Äî ') && author.length > 3) pass('shows an author line');
      else fail('shows an author line', 'author line missing');

      // Test 4: no unhandled promise rejections (NEW)
      if (UNHANDLED_REJECTIONS === 0) pass('no unhandled promise rejections');
      else fail('no unhandled promise rejections', `saw ${UNHANDLED_REJECTIONS}`);

      // Test 5: card aria-busy toggled off after render (NEW)
      const busy = document.getElementById('quote-card')?.getAttribute('aria-busy');
      if (busy === 'false') pass('sets aria-busy to false after render');
      else fail('sets aria-busy to false after render', `aria-busy is ${busy}`);

      // Test 6: hint reflects source (NEW)
      const hintText = document.getElementById('hint')?.textContent || '';
      if (/Loaded from (API|local list)/.test(hintText)) pass('hint reflects data source');
      else fail('hint reflects data source', 'hint did not mention API or local list');

      // Render results
      const out = document.getElementById('test-results');
      out.innerHTML = results.map(r => r.ok
        ? `<div class="test-pass">‚úî ${r.name}</div>`
        : `<div class="test-fail">‚úò ${r.name} ‚Äî ${r.msg}</div>`
      ).join('');
    }

    (async () => {
      const q = await getQuote();
      renderQuote(q);
      runTests();
    })();
  </script>
</body>
</html>
